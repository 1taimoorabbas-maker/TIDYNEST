---
import fs from 'node:fs';
import path from 'node:path';

import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/ProductCard.astro';

import siteData from '../../data/site.json';
import stylesData from '../../data/styles.json';
import productsData from '../../data/products.json';
import categoriesData from '../../data/categories.json';

import { getCategoryBySlug, getProductBySlug } from '../../lib/helpers';

export function getStaticPaths() {
  const { styles } = stylesData;
  return styles.map(style => ({
    params: { slug: style.slug },
    props: { style }
  }));
}

const { style } = Astro.props;
const { products } = productsData;

const category = getCategoryBySlug(categoriesData.categories, style.categorySlug);

const styleProducts = (style.productSlugs || [])
  .map((slug: string) => getProductBySlug(products, slug))
  .filter(Boolean);

const styleOgImage = `/images/styles/${style.slug}.jpg`;
const styleOgImageFile = path.join(process.cwd(), 'public', styleOgImage.replace(/^\//, ''));

const fallbackCategoryImage = category ? `/images/categories/${category.slug}.jpg` : '/images/og-default.svg';
const ogImage = fs.existsSync(styleOgImageFile) ? styleOgImage : fallbackCategoryImage;

const title = `${style.title} - ${siteData.siteName}`;
const description = style.description;
const pathname = `/styles/${style.slug}/`;
---

<BaseLayout title={title} description={description} pathname={pathname} ogImage={ogImage} ogType="website">
  <section class="bg-gradient-to-br from-stone-100 via-[#f6f7f5] to-[#e8ebe4] border-b border-stone-100">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
      <nav class="flex items-center text-sm text-stone-500 mb-6">
        <a href="/" class="hover:text-[color:var(--color-sage-700)] transition-colors">Home</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/styles/" class="hover:text-[color:var(--color-sage-700)] transition-colors">Styles</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-stone-800 truncate">{style.title}</span>
      </nav>

      {category && (
        <a href={`/category/${category.slug}/`} class="inline-block bg-[color:var(--color-sage-700)]/10 text-[color:var(--color-sage-700)] text-sm font-medium px-3 py-1 rounded-full mb-4 hover:bg-[color:var(--color-sage-700)]/20 transition-colors">
          {category.title}
        </a>
      )}

      <h1 class="font-serif text-3xl sm:text-4xl lg:text-5xl font-bold text-stone-800">
        {style.title}
      </h1>
      <p class="mt-4 text-lg text-stone-600 max-w-3xl">
        {style.description}
      </p>

      <div class="mt-8 flex flex-col sm:flex-row gap-3">
        {category && (
          <a href={`/category/${category.slug}/`} class="inline-flex items-center justify-center bg-white hover:bg-stone-50 text-stone-700 font-semibold py-3 px-6 rounded-xl transition-colors border border-stone-200">
            View all {category.title}
          </a>
        )}
        <a href="/products/" class="inline-flex items-center justify-center bg-[color:var(--color-sage-700)] hover:bg-[color:var(--color-sage-800)] text-white font-semibold py-3 px-6 rounded-xl transition-colors">
          Browse all products
        </a>
      </div>
    </div>
  </section>

  <section class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid lg:grid-cols-2 gap-8 items-start">
        <div class="aspect-[4/3] rounded-2xl overflow-hidden border border-stone-200 bg-stone-100">
          <img
            src={`/images/styles/${style.slug}.jpg`}
            alt={style.title}
            class="w-full h-full object-cover"
            onerror="this.onerror=null; this.src='/images/og-default.svg';"
          />
        </div>

        <div class="bg-stone-50 border border-stone-200 rounded-2xl p-6">
          <h2 class="font-serif text-2xl font-bold text-stone-800">What you’ll get</h2>
          <ul class="mt-4 space-y-2 text-stone-600">
            <li>• A curated set of products that match this style.</li>
            <li>• A more consistent look without overbuying.</li>
            <li>• Easy upgrades you can do in a weekend.</li>
          </ul>
          <p class="mt-4 text-xs text-stone-400">
            *Affiliate links may be used. We may earn a commission at no extra cost to you.
          </p>
        </div>
      </div>

      <h2 class="font-serif text-2xl font-bold text-stone-800 mt-12 mb-6">Shop this style</h2>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-6">
        {styleProducts.map((p: any) => <ProductCard product={p} />)}
      </div>
    </div>
  </section>
</BaseLayout>