---
import fs from 'node:fs';
import path from 'node:path';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductEmbed from '../../components/ProductEmbed.astro';
import ProductCard from '../../components/ProductCard.astro';
import GuideCard from '../../components/GuideCard.astro';
import siteData from '../../data/site.json';
import categoriesData from '../../data/categories.json';
import productsData from '../../data/products.json';
import guidesData from '../../data/guides.json';
import { 
  getCategoryBySlug,
  getProductBySlug,
  getGuidesByCategory,
  getProductsByCategory,
  getBadgeInfo
} from '../../lib/helpers';

export function getStaticPaths() {
  const { guides } = guidesData;
  
  return guides.map(guide => ({
    params: { slug: guide.slug },
    props: { guide }
  }));
}

const { guide } = Astro.props;
const { products } = productsData;
const { guides } = guidesData;

const category = getCategoryBySlug(categoriesData.categories, guide.categorySlug);
const relatedGuides = getGuidesByCategory(guides, guide.categorySlug).filter(g => g.slug !== guide.slug).slice(0, 2);
const categoryProducts = getProductsByCategory(products, guide.categorySlug);

// Get featured products from guide sections
const featuredProductSlugs = guide.sections.flatMap(s => s.productSlugs || []);
const featuredProducts = featuredProductSlugs.map(slug => getProductBySlug(products, slug)).filter(Boolean);

// Get top picks for callout
const topPick = categoryProducts.find(p => p.badge === 'top-pick');
const budgetPick = categoryProducts.find(p => p.badge === 'budget');
const premiumPick = categoryProducts.find(p => p.badge === 'premium');

const title = `${guide.title} - ${siteData.siteName}`;
const description = guide.description;
const pathname = `/guide/${guide.slug}/`;
const guideOgImage = `/images/guides/${guide.slug}.jpg`;
const guideOgImageFile = path.join(process.cwd(), 'public', guideOgImage.replace(/^\//, ''));

const ogImage = fs.existsSync(guideOgImageFile)
  ? guideOgImage
  : (category ? `/images/categories/${category.slug}.jpg` : '/images/og-default.svg');
---

<BaseLayout title={title} description={description} pathname={pathname} ogImage={ogImage} ogType="article">
  <!-- Guide Header -->
  <section class="relative bg-gradient-to-br from-stone-100 via-[#f6f7f5] to-[#e8ebe4] py-12 lg:py-16 overflow-hidden">
    <div class="absolute inset-0 opacity-10">
      <div class="absolute top-20 right-20 w-72 h-72 bg-[#788a66] rounded-full blur-3xl"></div>
    </div>
    
    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex items-center text-sm text-stone-500 mb-6">
        <a href="/" class="hover:text-[#5e6d50] transition-colors">Home</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/guides/" class="hover:text-[#5e6d50] transition-colors">Guides</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-stone-800 truncate">{guide.title}</span>
      </nav>
      
      {category && (
        <a href={`/category/${category.slug}/`} class="inline-block bg-[#5e6d50]/10 text-[#5e6d50] text-sm font-medium px-3 py-1 rounded-full mb-4 hover:bg-[#5e6d50]/20 transition-colors">
          {category.title}
        </a>
      )}
      
      <h1 class="font-serif text-3xl sm:text-4xl lg:text-5xl font-bold text-stone-800 mb-4">
        {guide.title}
      </h1>
      
      <p class="text-lg text-stone-600 mb-6">
        {guide.description}
      </p>
      
      <!-- Pinterest Save -->
      <a 
        href={`https://pinterest.com/pin/create/button/?url=${encodeURIComponent(siteData.siteDomain + pathname)}&media=${encodeURIComponent(siteData.siteDomain + ogImage)}&description=${encodeURIComponent(guide.title)}`}
        target="_blank"
        rel="noopener"
        class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm"
      >
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0a12 12 0 0 0-4.373 23.178c-.07-.937-.134-2.377.028-3.401.146-.926.943-5.893.943-5.893s-.24-.481-.24-1.192c0-1.117.648-1.951 1.454-1.951.686 0 1.017.515 1.017 1.132 0 .69-.439 1.72-.666 2.677-.19.8.402 1.452 1.192 1.452 1.43 0 2.529-1.508 2.529-3.684 0-1.926-1.384-3.273-3.36-3.273-2.29 0-3.633 1.716-3.633 3.493 0 .691.266 1.432.599 1.834a.24.24 0 0 1 .056.23c-.061.254-.197.8-.224.912-.035.146-.116.178-.268.107-1-.465-1.624-1.926-1.624-3.1 0-2.523 1.834-4.84 5.286-4.84 2.775 0 4.932 1.977 4.932 4.62 0 2.757-1.739 4.976-4.151 4.976-.811 0-1.573-.421-1.834-.919l-.498 1.902c-.181.695-.669 1.566-.995 2.097A12 12 0 1 0 12 0z"/>
        </svg>
        Save to Pinterest
      </a>
    </div>
  </section>
  
  <!-- Featured Image -->
  <section class="bg-white py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="aspect-[21/9] rounded-2xl overflow-hidden shadow-lg">
        <img 
          src={`/images/guides/${guide.slug}.jpg`}
          alt={guide.title}
          class="w-full h-full object-cover"
          onerror="this.onerror=null; this.src='/images/placeholder-guide.svg';"
        >
      </div>
    </div>
  </section>
  
  <!-- Table of Contents -->
  <section class="py-8 bg-stone-50 border-y border-stone-200">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="font-semibold text-stone-800 mb-4">In This Guide:</h2>
      <nav class="space-y-2">
        {guide.sections.map((section, index) => (
          <a 
            href={`#section-${index}`}
            class="flex items-center text-[#5e6d50] hover:text-[#4a5641] transition-colors"
          >
            <span class="w-6 h-6 bg-[#5e6d50]/10 rounded-full flex items-center justify-center text-sm font-medium mr-3">
              {index + 1}
            </span>
            {section.heading}
          </a>
        ))}
        {guide.faqs && guide.faqs.length > 0 && (
          <a href="#faq" class="flex items-center text-[#5e6d50] hover:text-[#4a5641] transition-colors">
            <span class="w-6 h-6 bg-[#5e6d50]/10 rounded-full flex items-center justify-center text-sm font-medium mr-3">?</span>
            Frequently Asked Questions
          </a>
        )}
      </nav>
    </div>
  </section>
  
  <!-- Quick Picks Callout -->
  {(topPick || budgetPick || premiumPick) && (
    <section class="py-8 bg-white border-b border-stone-100">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-gradient-to-r from-[#5e6d50]/5 to-[#788a66]/5 rounded-xl p-6 border border-[#5e6d50]/20">
          <h3 class="font-serif text-xl font-bold text-stone-800 mb-4">âš¡ Quick Picks</h3>
          <div class="grid sm:grid-cols-3 gap-4">
            {topPick && (
              <a href={`/product/${topPick.slug}/`} class="bg-white rounded-lg p-4 border border-stone-200 hover:border-[#5e6d50] hover:shadow-md transition-all group">
                <span class="text-xs font-semibold text-emerald-600 uppercase tracking-wider">Top Pick</span>
                <p class="font-medium text-stone-800 group-hover:text-[#5e6d50] mt-1 line-clamp-2">{topPick.title}</p>
              </a>
            )}
            {budgetPick && (
              <a href={`/product/${budgetPick.slug}/`} class="bg-white rounded-lg p-4 border border-stone-200 hover:border-[#5e6d50] hover:shadow-md transition-all group">
                <span class="text-xs font-semibold text-amber-600 uppercase tracking-wider">Best Budget</span>
                <p class="font-medium text-stone-800 group-hover:text-[#5e6d50] mt-1 line-clamp-2">{budgetPick.title}</p>
              </a>
            )}
            {premiumPick && (
              <a href={`/product/${premiumPick.slug}/`} class="bg-white rounded-lg p-4 border border-stone-200 hover:border-[#5e6d50] hover:shadow-md transition-all group">
                <span class="text-xs font-semibold text-purple-600 uppercase tracking-wider">Premium Choice</span>
                <p class="font-medium text-stone-800 group-hover:text-[#5e6d50] mt-1 line-clamp-2">{premiumPick.title}</p>
              </a>
            )}
          </div>
        </div>
      </div>
    </section>
  )}
  
  <!-- Guide Content -->
  <article class="py-12 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      {guide.sections.map((section, index) => {
        const sectionProducts = (section.productSlugs || [])
          .map(slug => getProductBySlug(products, slug))
          .filter(Boolean);
        
        return (
          <section id={`section-${index}`} class="mb-12 scroll-mt-24">
            <h2 class="font-serif text-2xl lg:text-3xl font-bold text-stone-800 mb-4 flex items-center">
              <span class="w-10 h-10 bg-[#5e6d50] text-white rounded-full flex items-center justify-center text-lg font-semibold mr-4 flex-shrink-0">
                {index + 1}
              </span>
              {section.heading}
            </h2>
            
            <div class="prose prose-stone max-w-none ml-14">
              {section.paragraphs.map(paragraph => (
                <p class="text-stone-600 leading-relaxed mb-4">{paragraph}</p>
              ))}
            </div>
            
            {sectionProducts.length > 0 && (
              <div class="mt-6 ml-14 space-y-4">
                {sectionProducts.map((product, pIndex) => (
                  <ProductEmbed 
                    product={product} 
                    variant={pIndex === 0 && product.badge === 'top-pick' ? 'featured' : 'default'} 
                  />
                ))}
              </div>
            )}
          </section>
        );
      })}
    </div>
  </article>
  
  <!-- FAQ Section -->
  {guide.faqs && guide.faqs.length > 0 && (
    <section id="faq" class="py-12 bg-stone-50 scroll-mt-24">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="font-serif text-2xl lg:text-3xl font-bold text-stone-800 text-center mb-8">
          Frequently Asked Questions
        </h2>
        
        <div class="space-y-4">
          {guide.faqs.map((faq, index) => (
            <details class="group bg-white rounded-xl overflow-hidden shadow-sm border border-stone-200" open={index === 0}>
              <summary class="flex items-center justify-between p-5 cursor-pointer font-medium text-stone-800 hover:bg-stone-50 transition-colors">
                {faq.question}
                <svg class="w-5 h-5 text-stone-500 group-open:rotate-180 transition-transform flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-5 text-stone-600 border-t border-stone-100 pt-4">
                {faq.answer}
              </div>
            </details>
          ))}
        </div>
      </div>
    </section>
  )}
  
  <!-- CTA Section -->
  <section class="py-12 bg-gradient-to-br from-[#5e6d50] to-[#4a5641]">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-serif text-2xl lg:text-3xl font-bold text-white mb-4">
        Ready to Get Started?
      </h2>
      <p class="text-white/80 mb-8">
        Browse all our recommended products for {category ? category.title.toLowerCase() : 'home organization'}.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        {category && (
          <a href={`/category/${category.slug}/`} class="inline-flex items-center justify-center bg-white hover:bg-stone-100 text-[#5e6d50] font-semibold py-3 px-8 rounded-xl transition-colors">
            Browse {category.title}
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        )}
        <a href="/products/" class="inline-flex items-center justify-center bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-8 rounded-xl transition-colors border border-white/20">
          View All Products
        </a>
      </div>
    </div>
  </section>
  
  <!-- Related Guides -->
  {relatedGuides.length > 0 && (
    <section class="py-12 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="font-serif text-2xl font-bold text-stone-800 text-center mb-8">
          Related Guides
        </h2>
        <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
          {relatedGuides.map(relGuide => (
            <GuideCard guide={relGuide} />
          ))}
        </div>
      </div>
    </section>
  )}
  
  <!-- Category Products -->
  <section class="py-12 bg-stone-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="font-serif text-2xl font-bold text-stone-800 text-center mb-8">
        More {category ? category.title : 'Organization'} Products
      </h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-6">
        {categoryProducts.slice(0, 4).map(product => (
          <ProductCard product={product} />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
